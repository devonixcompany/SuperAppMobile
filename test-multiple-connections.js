const WebSocket = require('ws');

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ charge point
function createChargePointConnection(chargePointId, serialNumber) {
  return new Promise((resolve, reject) => {
    const ws = new WebSocket('ws://localhost:8081', 'ocpp1.6');
    
    const connectionData = {
      chargePointId,
      serialNumber,
      ws,
      connected: false,
      authenticated: false,
      messages: []
    };

    ws.on('open', () => {
      console.log(`üîå ${chargePointId}: ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`);
      connectionData.connected = true;
      
      // ‡∏™‡πà‡∏á BootNotification
      const bootNotification = [2, "1", "BootNotification", {
        "chargePointVendor": "EVBangna",
        "chargePointModel": "CP-Model-001",
        "chargePointSerialNumber": serialNumber,
        "firmwareVersion": "1.0.0"
      }];
      
      ws.send(JSON.stringify(bootNotification));
      console.log(`üì§ ${chargePointId}: ‡∏™‡πà‡∏á BootNotification`);
    });

    ws.on('message', (data) => {
      try {
        const message = JSON.parse(data.toString());
        connectionData.messages.push(message);
        console.log(`üì• ${chargePointId}: ‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°`, message);
        
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö BootNotification Response
        if (message[0] === 3 && message[1] === "1") {
          if (message[2].status === "Accepted") {
            connectionData.authenticated = true;
            console.log(`‚úÖ ${chargePointId}: BootNotification ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏¢‡∏≠‡∏°‡∏£‡∏±‡∏ö`);
            
            // ‡∏™‡πà‡∏á Heartbeat
            setTimeout(() => {
              const heartbeat = [2, "2", "Heartbeat", {}];
              ws.send(JSON.stringify(heartbeat));
              console.log(`üíì ${chargePointId}: ‡∏™‡πà‡∏á Heartbeat`);
            }, 1000);
          }
        }
        
        // ‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö Heartbeat Response
        if (message[0] === 3 && message[1] === "2") {
          console.log(`üíì ${chargePointId}: ‡∏£‡∏±‡∏ö Heartbeat Response`);
        }
        
      } catch (error) {
        console.error(`‚ùå ${chargePointId}: Error parsing message:`, error);
      }
    });

    ws.on('close', (code, reason) => {
      console.log(`üîå ${chargePointId}: ‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏õ‡∏¥‡∏î - Code: ${code}, Reason: ${reason}`);
      connectionData.connected = false;
    });

    ws.on('error', (error) => {
      console.error(`‚ùå ${chargePointId}: WebSocket error:`, error);
      reject(error);
    });

    // ‡∏£‡∏≠‡πÉ‡∏´‡πâ‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå
    setTimeout(() => {
      resolve(connectionData);
    }, 2000);
  });
}

// ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏´‡∏•‡∏≤‡∏¢‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô
async function testMultipleConnections() {
  console.log('üöÄ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏´‡∏•‡∏≤‡∏¢‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô...\n');
  
  const chargePoints = [
    { id: 'EVBANGNA-CP001', serial: 'SN001' },
    { id: 'EVBANGNA-CP002', serial: 'SN002' },
    { id: 'EVBANGNA-CP003', serial: 'SN003' },
    { id: 'EVBANGNA-CP004', serial: 'SN004' },
    { id: 'EVBANGNA-CP005', serial: 'SN005' }
  ];

  try {
    // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô
    const connectionPromises = chargePoints.map(cp => 
      createChargePointConnection(cp.id, cp.serial)
    );
    
    console.log(`üì° ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ ${chargePoints.length} ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô...\n`);
    
    const connections = await Promise.all(connectionPromises);
    
    // ‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ñ‡∏π‡∏Å‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•
    await new Promise(resolve => setTimeout(resolve, 3000));
    
    // ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö
    console.log('\nüìä ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö:');
    console.log('='.repeat(50));
    
    let connectedCount = 0;
    let authenticatedCount = 0;
    
    connections.forEach(conn => {
      const status = conn.connected ? 'üü¢ ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠' : 'üî¥ ‡πÑ‡∏°‡πà‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠';
      const auth = conn.authenticated ? '‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô' : '‚ùå ‡πÑ‡∏°‡πà‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô';
      
      console.log(`${conn.chargePointId}: ${status} | ${auth} | ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°: ${conn.messages.length}`);
      
      if (conn.connected) connectedCount++;
      if (conn.authenticated) authenticatedCount++;
    });
    
    console.log('='.repeat(50));
    console.log(`üìà ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠:`);
    console.log(`   - ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${connectedCount}/${chargePoints.length}`);
    console.log(`   - ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${authenticatedCount}/${chargePoints.length}`);
    
    if (connectedCount === chargePoints.length && authenticatedCount === chargePoints.length) {
      console.log('\nüéâ ‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏´‡∏•‡∏≤‡∏¢‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÑ‡∏î‡πâ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
    } else {
      console.log('\n‚ö†Ô∏è ‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ö‡∏≤‡∏á‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á');
    }
    
    // ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
    console.log('\nüîå ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î...');
    connections.forEach(conn => {
      if (conn.ws && conn.ws.readyState === WebSocket.OPEN) {
        conn.ws.close();
      }
    });
    
  } catch (error) {
    console.error('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö:', error);
  }
}

// ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö
testMultipleConnections();