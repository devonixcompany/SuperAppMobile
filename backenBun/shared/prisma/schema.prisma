// This is a shared Prisma schema for all services
// Generated by merging schemas from all microservices

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== USER SERVICE MODELS ====================

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  username  String   @unique
  firstName String
  lastName  String
  password  String
  avatar    String?
  phone     String?
  role      UserRole @default(USER)
  status    UserStatus @default(ACTIVE)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  refreshTokens RefreshToken[]

  @@map("users")
}

model RefreshToken {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String
  expiresAt DateTime
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("refresh_tokens")
}

model BlacklistedToken {
  id        String   @id @default(cuid())
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@map("blacklisted_tokens")
}

enum UserRole {
  USER
  ADMIN
  MODERATOR
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

// ==================== STATION SERVICE MODELS ====================

model Station {
  id          String           @id @default(cuid())
  stationId   String           @unique
  name        String
  operatorId  String?
  locationLat Decimal?         @map("location_lat")
  locationLng Decimal?         @map("location_lng")
  address     Json?
  status      StationStatus    @default(ACTIVE)
  ocppVersion String           @default("1.6") @map("ocpp_version")
  createdAt   DateTime         @default(now()) @map("created_at")
  updatedAt   DateTime         @updatedAt @map("updated_at")

  // Relations
  connectors  Connector[]
  chargePoints ChargePoint[]

  @@map("stations")
}

model Connector {
  id            String         @id @default(cuid())
  stationId     String         @map("station_id")
  connectorId   Int            @map("connector_id")
  chargePointId String?        @map("charge_point_id")
  type          ConnectorType  @default(TYPE_2)
  powerRating   Int            @default(22000) @map("power_rating")
  status        ConnectorStatus @default(AVAILABLE)

  // Relations
  station     Station     @relation(fields: [stationId], references: [id], onDelete: Cascade)
  chargePoint ChargePoint? @relation(fields: [chargePointId], references: [id], onDelete: SetNull)

  @@unique([stationId, connectorId])
  @@map("connectors")
}

enum StationStatus {
  ACTIVE
  INACTIVE
  MAINTENANCE
  DECOMMISSIONED
}

enum ConnectorType {
  TYPE_1
  TYPE_2
  CHADEMO
  CCS
  TESLA
  DOMESTIC
}

enum ConnectorStatus {
  AVAILABLE
  OCCUPIED
  RESERVED
  UNAVAILABLE
  FAULTED
  MAINTENANCE
}

// ==================== CHARGE POINT SERVICE MODELS ====================

model ChargePoint {
  id                    String              @id @default(cuid())
  chargePointId         String              @unique @map("charge_point_id")
  stationId             String              @map("station_id")
  vendor                String
  model                 String
  serialNumber          String?             @map("serial_number")
  chargeBoxSerialNumber String?             @map("charge_box_serial_number")
  firmwareVersion       String?             @map("firmware_version")
  iccid                 String?
  imsi                  String?
  meterType             String?
  meterSerialNumber     String?             @map("meter_serial_number")
  ocppVersion           String              @default("1.6")
  status                ChargePointStatus   @default(DISCONNECTED)
  lastSeen              DateTime?           @map("last_seen")
  location              Json?
  configuration         Json?
  createdAt             DateTime            @default(now()) @map("created_at")
  updatedAt             DateTime            @updatedAt @map("updated_at")

  // Relations
  station     Station      @relation(fields: [stationId], references: [id], onDelete: Cascade)
  connectors  Connector[]
  transactions Transaction[]

  @@map("charge_points")
}

model Transaction {
  id                    String                 @id @default(cuid())
  transactionId         Int                    @unique
  chargePointId         String
  connectorId           Int
  idTag                 String
  startTimestamp        DateTime
  stopTimestamp         DateTime?
  startMeterValue       Int
  stopMeterValue        Int?
  energyConsumed        Float?                 // kWh
  status                TransactionStatus      @default(STARTED)
  reason                String?
  metadata              Json?
  createdAt             DateTime               @default(now())
  updatedAt             DateTime               @updatedAt

  // Relations
  chargePoint ChargePoint @relation(fields: [chargePointId], references: [id], onDelete: Cascade)

  @@map("transactions")
}

enum ChargePointStatus {
  DISCONNECTED
  CONNECTED
  AVAILABLE
  UNAVAILABLE
  FAULTED
  MAINTENANCE
}

enum TransactionStatus {
  STARTED
  STOPPED
  SUSPENDED
  COMPLETED
  FAILED
}