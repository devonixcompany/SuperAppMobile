generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String        @id @default(uuid())                              
  firebaseUid   String        @unique                         
  email         String        @unique                        
  phoneNumber   String        @unique                         
  fullName      String?                                       
  password      String
  status        String        @default("PENDING")
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  typeUser      UserType?
  refresh_token String?
  chargePoints  ChargePoint[] @relation("UserChargePoints")
  transactions  Transaction[]
  vehicles      UserVehicle[]
  rfidCards      RfidCard[]   @relation("UserOwnedRfidCards")   // บัตร RFID ที่ผู้ใช้นี้เป็นเจ้าของ
  issuedRfidCards RfidCard[]  @relation("UserIssuedRfidCards")  // บัตร RFID ที่ผู้ใช้นี้เป็นผู้ออกให้ผู้อื่น
}

model UserVehicle {
  id           String        @id @default(cuid())
  userId       String
  licensePlate String        @unique
  make         String?
  model        String?
  type         VehicleType   @default(ELECTRIC)
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  transactions Transaction[]
  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_vehicles")
}

model RfidCard {
  id             String         @id @default(cuid())
  ownerId        String
  owner          User           @relation("UserOwnedRfidCards", fields: [ownerId], references: [id]) // ผู้ใช้ที่เป็นเจ้าของบัตร
  cardNumber     String         @unique @db.VarChar(64)           // หมายเลข UID/SN ของบัตร
  qrCodeValue    String?        @unique @db.VarChar(128)          // ค่า QR (ถ้ามี) สำหรับสแกนลงทะเบียน
  alias          String?        @db.VarChar(64)                   // ชื่อเล่นของบัตรที่ผู้ใช้ตั้งเอง
  isPrimary      Boolean        @default(false)                   // true เมื่อเป็นบัตรหลักของเจ้าของ
  status         RfidCardStatus @default(ACTIVE)                  // สถานะการใช้งานของบัตร
  issuedById     String?
  issuedBy       User?          @relation("UserIssuedRfidCards", fields: [issuedById], references: [id]) // ผู้ใช้ที่ออกบัตรใบนี้ให้
  activatedAt    DateTime?                                        // เวลาที่บัตรถูกยืนยันใช้งาน
  lastUsedAt     DateTime?                                        // เวลาที่บัตรถูกใช้ครั้งล่าสุด
  revokedAt      DateTime?                                        // เวลาที่บัตรถูกเพิกถอน
  deletedAt      DateTime?                                        // เวลาที่ลบบัตรแบบ soft delete
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt

  @@index([ownerId, status])    // ช่วยค้นหาบัตรตามเจ้าของ/สถานะ
  @@index([ownerId, isPrimary]) // ช่วยตรวจว่าเจ้าของมีบัตรหลักแล้วหรือไม่
}


enum RfidCardStatus {
  ACTIVE
  INACTIVE
  LOST
  REVOKED
}


model SsTaxInvoiceProfile {
  id             String        @id @default(uuid())
  userId         String                               //ผูกกับเจ้าของโปรไฟล์
  taxpayerType   TaxpayerType                         //(enum: PERSONAL | JURISTIC) — บุคคลธรรมดา/นิติบุคคล
  fullName       String?                              //ชื่อ-นามสกุล (บุคคลธรรมดา)
  companyName    String?                              //ชื่อบริษัท (นิติบุคคล)
  taxId          String        @db.VarChar(20)        //เลขประจำตัวผู้เสียภาษี (บุคคลธรรมดา 13 หลัก / นิติบุคคล 10 หลัก)
  branchType     BranchType?                          //(enum: HEAD_OFFICE | BRANCH) — สำนักงานใหญ่/สาขา (นิติบุคคล) 
  branchCode     String?       @db.VarChar(5)         //รหัสสาขา (นิติบุคคล) เช่น "00000" = สำนักงานใหญ่, "00001" = สาขา 1

  addressLine1   String                               //ที่อยู่บรรทัดที่ 1 
  addressLine2   String?                              //ที่อยู่บรรทัดที่ 2
  provinceId   String                                  //จังหวัด
  districtId   String                                  //อำเภอ
  subdistrictId String                                 //ตำบล
  postalCode   String        @db.VarChar(10)

  isDefault    Boolean       @default(false)          //ตั้งเป็นค่าเริ่มต้น
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  @@index([userId])
  // กันซ้ำต่อผู้ใช้: taxId + branchCode (นิติบุคคล) หรือ taxId (บุคคล)
  @@unique([userId, taxId, branchCode])
}
model Station {
  id               String            @id @default(uuid())
  stationname      String            @unique
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  chargePoints ChargePoint[]  @relation("StationChargePoints")
}



model ChargePoint {
  id               String            @id @default(cuid()) // รหัสจุดชาร์จ เช่น "CP_BKK_001", "CP_CNX_002"
  name             String            @map("chargepointname")
  stationName      String?            // ชื่อจุดชาร์จ เช่น "Central World", "Big C Ladprao"
  stationId        String?                 // รหัสสถานี (foreign key ไปยัง Station.id)
  location         String            // ที่อยู่ เช่น "999/9 Rama I Rd, Pathumwan, Bangkok"
  latitude         Decimal?          // ละติจูด เช่น 13.7563 (สำหรับแสดงบนแผนที่)
  longitude        Decimal?          // ลองจิจูด เช่น 100.5018 (สำหรับแสดงบนแผนที่)

  // เวลาเปิด-ปิด
  openingHours     String?           // เวลาเปิด-ปิด เช่น "06:00-22:00" หรือ "24/7"
  is24Hours        Boolean           @default(false) // ตลอด 24 ชั่วโมงหรือไม่

  // ข้อมูลเครื่องชาร์จ
  brand            String            // ยี่ห้อ/รุ่น เช่น "Autel MaxiCharger AC Wallbox 7kW"
  serialNumber     String            @unique // Serial Number เช่น "SN-AUTEL-23-001234" (ไม่ซ้ำ, A-Z 0-9 -/_)
  powerRating      Float             // กำลังไฟ (kW) เช่น 7.4, 11, 22, 50 (> 0, ทศนิยม ≤ 2 ตำแหน่ง)
  powerSystem      Int               @default(1)// ระบบไฟฟ้า: 1 = Single Phase, 3 = Three Phase
  connectorCount   Int               @default(1) // จำนวนหัวชาร์จ เช่น 1, 2, 4 (≥ 1)

  protocol         OCPPVersion       // เวอร์ชัน OCPP ที่รองรับ: OCPP16, OCPP20, OCPP21
  csmsUrl          String?           // URL ของ CSMS (Central System Management Software) สำหรับ OCPP
  chargePointIdentity String         @unique // Charge Point Identity สำหรับ BootNotification (1-36 ตัวอักษร, A-Z 0-9 -_)



  status          ChargePointStatus @default(AVAILABLE) @map("chargepointstatus") // สถานะ: AVAILABLE, OCCUPIED, UNAVAILABLE, FAULTED, MAINTENANCE
  maxPower         Float?            // กำลังไฟสูงสุด เช่น 22.0 (kW), 50.0 (kW) - deprecated, ใช้ powerRating แทน


  // ฟิลด์ใหม่สำหรับ OCPP connection tracking
  lastSeen             DateTime?         // อัปเดตตอน Heartbeat/Boot
  heartbeatIntervalSec Int?              // จาก BootNotification หรือ Config
  vendor               String?           // จาก BootNotification
  model                String?           // จาก BootNotification
  firmwareVersion      String?           // จาก BootNotification (ถ้ามี)
  ocppProtocolRaw      String?           // เช่น "ocpp1.6"
  ocppSessionId        String?           // ไอดีภายในของการเชื่อมต่อปัจจุบัน (ถ้ามี)
  // helper flags
  isWhitelisted        Boolean           @default(true) // เปิด/ปิดอนุญาตเชื่อมต่อ

  ownerId          String?           // ID ของเจ้าของ (null = สาธารณะ)
  ownershipType    OwnershipType     @default(PUBLIC) // ประเภทความเป็นเจ้าของ: PUBLIC, PRIVATE, SHARED
  isPublic         Boolean           @default(true) // เปิดให้บริการสาธารณะหรือไม่

  // การตั้งราคาแบบง่าย - On-Peak และ Off-Peak
  onPeakRate       Float             @default(10.0) // ราคา on-peak (บาท/kWh) เช่น 10.0
  onPeakStartTime  String            @default("10:00") // เวลาเริ่ม on-peak เช่น "10:00"
  onPeakEndTime    String            @default("12:00") // เวลาสิ้นสุด on-peak เช่น "12:00"
  offPeakRate      Float             @default(20.0) // ราคา off-peak (บาท/kWh) เช่น 20.0
  offPeakStartTime String            @default("16:00") // เวลาเริ่ม off-peak เช่น "16:00"
  offPeakEndTime   String            @default("22:00") // เวลาสิ้นสุด off-peak เช่น "22:00"

  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt

  owner            User?             @relation("UserChargePoints", fields: [ownerId], references: [id])
  connectors       Connector[]       // หัวชาร์จทั้งหมดในจุดนี้
  transactions     Transaction[]     // ธุรกรรมทั้งหมดที่เกิดขึ้นในจุดนี้
  urlwebSocket     String?           // URL ของ WebSocket สำหรับเชื่อมต่อกับเซิร์ฟเวอร์ OCPP
  station          Station?          @relation("StationChargePoints", fields: [stationId], references: [id])

  @@map("charge_points")
}

model Connector {
  id                String            @id @default(cuid())
  chargePointId     String
  connectorId       Int
  type              ConnectorType     @default(TYPE_2)
  typeDescription   String?        // ข้อความชนิดหัวชาร์จที่รับมาจาก OCPP (raw string)


  status            ConnectorStatus   @default(AVAILABLE) @map("connectorstatus")
  maxPower          Float?
  maxCurrent        Float?
  chargePoint       ChargePoint       @relation(fields: [chargePointId], references: [id], onDelete: Cascade)
  transactions      Transaction[]

  @@unique([chargePointId, connectorId])
  @@map("connectors")
}

model Admin {
  id           String   @id @default(uuid())
  email        String   @unique
  password     String
  role         AdminRole @default(STAFF)
  firstName    String?
  lastName     String?
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  refreshTokens AdminRefreshToken[]
}

model AdminRefreshToken {
  id           String   @id @default(cuid())
  token        String   @unique
  adminId      String
  expiresAt    DateTime
  createdAt    DateTime @default(now())
  isRevoked    Boolean  @default(false)
  revokedAt    DateTime?
  admin        Admin     @relation(fields: [adminId], references: [id], onDelete: Cascade)

  @@map("admin_refresh_tokens")
}

enum AdminRole {
  SUPERADMIN
  STAFF
}

model Transaction {
  id              String            @id @default(cuid())
  transactionId   String            @unique
  ocppTransactionId String?         @unique
  userId          String
  vehicleId       String?
  chargePointId   String
  connectorId     String
  startTime       DateTime
  endTime         DateTime?
  startMeterValue Float             @default(0)
  endMeterValue   Float?
  totalEnergy     Float?
  totalCost       Float?
  appliedRate     Float?
  status          TransactionStatus @default(ACTIVE)
  stopReason      String?
  chargePoint     ChargePoint       @relation(fields: [chargePointId], references: [id])
  connector       Connector         @relation(fields: [connectorId], references: [id])
  user            User              @relation(fields: [userId], references: [id])
  vehicle         UserVehicle?      @relation(fields: [vehicleId], references: [id])

  @@map("transactions")
}

model OCPPMessage {
  id            String           @id @default(cuid())
  messageId     String
  chargePointId String
  direction     MessageDirection
  action        String
  payload       Json
  timestamp     DateTime         @default(now())

  @@map("ocpp_messages")
}

model Notification {
  id        String           @id @default(cuid())
  userId    String?
  title     String
  message   String
  type      NotificationType
  isRead    Boolean          @default(false)
  createdAt DateTime         @default(now())

  @@map("notifications")
}


enum UserStatus {
  ACTIVE
  BLOCKED
  EXPIRED
}

enum VehicleType {
  ELECTRIC
  HYBRID
  PLUGIN_HYBRID
}

enum OwnershipType {
  PUBLIC
  PRIVATE
  SHARED
}

enum OCPPVersion {
  OCPP16
  OCPP20
  OCPP21
}

enum ChargePointStatus {
  AVAILABLE
  OCCUPIED
  UNAVAILABLE
  FAULTED
  MAINTENANCE
}

enum ConnectorType {
  TYPE_1
  TYPE_2
  CHADEMO
  CCS_COMBO_1
  CCS_COMBO_2
  TESLA
  GB_T
}

enum ConnectorStatus {
  AVAILABLE
  PREPARING
  CHARGING
  SUSPENDED_EV
  SUSPENDED_EVSE
  RESERVED
  UNAVAILABLE
  FAULTED
}

enum TransactionStatus {
  ACTIVE
  COMPLETED
  FAILED
  CANCELED
}

enum SessionStatus {
  ACTIVE
  COMPLETED
  FAILED
  TIMEOUT
}

enum ReservationStatus {
  ACTIVE
  COMPLETED
  CANCELED
  EXPIRED
}

enum RateUnit {
  A
  W
  kW
}

enum MessageDirection {
  INBOUND
  OUTBOUND
}

enum NotificationType {
  CHARGING_STARTEDChargePoint
  CHARGING_STOPPED
  CHARGING_COMPLETED
  PAYMENT_REQUIRED
  SYSTEM_MAINTENANCE
  GENERAL
}

enum UserType {
  NORMAL
  BUSINESS
}





enum PricingTierType {
  STANDARD
  PEAK_OFF_PEAK
  TIME_OF_USE
  DYNAMIC
}
enum TaxpayerType {
  PERSONAL
  JURISTIC
}

enum BranchType {
  HEAD_OFFICE
  BRANCH
}
